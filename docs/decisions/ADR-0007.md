# ADR: Backend-as-a-Service ‚Äî Supabase

**ID**: ADR-0007
**Fecha**: 2026-02-15
**Estado**: üü° Propuesto
**Autor**: Claude / Aritz

## 1. Contexto y Problema

OPTEK necesita: autenticaci√≥n de usuarios (email, OAuth), base de datos relacional (tests, legislaci√≥n, perfiles), almacenamiento de archivos (PDFs legislaci√≥n, audio futuro), base de datos vectorial (embeddings para RAG), y Row Level Security (cada usuario ve solo sus datos). Todo esto con coste reducido para un equipo de 1-2 personas sin DevOps dedicado.

## 2. Opciones Consideradas

- **Opci√≥n A**: Supabase ‚Äî BaaS open-source sobre PostgreSQL. Auth, DB, Storage, Realtime, Edge Functions, pgvector incluido. Plan Pro ~$25/mes. SDK para JavaScript/TypeScript.
- **Opci√≥n B**: Firebase (Google) ‚Äî BaaS propietario. Auth excelente, Firestore (NoSQL), Storage. No tiene base vectorial integrada (requerir√≠a servicio adicional). Pricing por lectura/escritura puede escalar de forma impredecible.
- **Opci√≥n C**: PostgreSQL autoalojado (Railway/Render) + Auth0/Clerk ‚Äî M√°ximo control pero requiere gestionar infraestructura, backups, conexiones, auth por separado. Mayor complejidad operativa.
- **Opci√≥n D**: PlanetScale + Clerk + S3 ‚Äî Stack modular con MySQL (PlanetScale), auth (Clerk), storage (S3). Cada servicio es excelente pero la integraci√≥n requiere m√°s c√≥digo glue.

## 3. Decisi√≥n Elegida: Supabase

**Justificaci√≥n T√©cnica**:

1. **PostgreSQL nativo**: Modelo relacional puro para legislaci√≥n normalizada (leyes ‚Üí art√≠culos ‚Üí chunks). SQL completo con JOINs, CTEs, funciones, triggers. Superior a Firestore (NoSQL) para nuestro schema.
2. **pgvector integrado**: Embeddings vectoriales en la misma DB que los datos relacionales. Una query puede hacer JOIN entre legislaci√≥n y b√∫squeda vectorial. Sin servicio adicional (ver ADR-0002).
3. **Auth integrado**: Email/password, Magic Link, OAuth (Google). Middleware de Next.js con `@supabase/ssr`. RLS basado en `auth.uid()` para aislamiento de datos por usuario.
4. **Row Level Security**: Pol√≠ticas declarativas que garantizan que cada usuario solo accede a sus tests, desarrollos, y datos de perfil. Seguridad a nivel de base de datos, no de aplicaci√≥n.
5. **Storage**: Supabase Storage para PDFs de legislaci√≥n original y audio (Fase 2B). Con pol√≠ticas RLS para archivos privados de usuarios.
6. **Coste predecible**: Plan Pro $25/mes incluye todo (8GB DB, 250GB storage, 500k auth MAU, pgvector). Firebase puede escalar impredeciblemente con lecturas.
7. **Open source**: Si necesitamos migrar, Supabase es PostgreSQL est√°ndar. Sin lock-in de datos.

## 4. Consecuencias (Trade-offs)

- **Positivas**: Stack unificado (auth+DB+storage+vectors), PostgreSQL est√°ndar (portabilidad), RLS nativo, coste fijo y predecible, SDK TypeScript maduro.
- **Negativas/Riesgos**: Menos features realtime que Firebase (mitigado: no necesitamos realtime para MVP). Dashboard de Supabase menos maduro que Firebase Console. Dependency on Supabase infrastructure (mitigado: es PostgreSQL est√°ndar, migrable a cualquier PG). Necesita DPA para GDPR (incluido en plan Pro).

## 5. Notas de Implementaci√≥n

- Cliente server-side: `/lib/supabase/server.ts` con `createServerClient()`.
- Cliente browser: `/lib/supabase/client.ts` con `createBrowserClient()`.
- Middleware auth: `/middleware.ts` con refresh de sesi√≥n.
- Schema SQL con RLS en PLAN.md (secci√≥n 0.2).
- Staging: proyecto Supabase separado para environment de testing.
- Backups: autom√°ticos en plan Pro (7 d√≠as retenci√≥n).
- Tipos generados: `supabase gen types typescript` para type safety end-to-end.
