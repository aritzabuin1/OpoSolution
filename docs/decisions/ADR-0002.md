# ADR: Base de Datos Vectorial ‚Äî pgvector en Supabase

**ID**: ADR-0002
**Fecha**: 2026-02-15
**Estado**: üü¢ Aceptado
**Autor**: Claude / Aritz

## 1. Contexto y Problema

OPTEK necesita b√∫squeda sem√°ntica para recuperar art√≠culos de legislaci√≥n relevantes dado un tema o pregunta del usuario. El RAG pipeline requiere una base de datos vectorial que almacene embeddings de ~5.000-15.000 chunks de legislaci√≥n (MVP) con capacidad de escalar a ~50.000+ cuando se a√±adan m√°s oposiciones.

## 2. Opciones Consideradas

- **Opci√≥n A**: pgvector (extensi√≥n PostgreSQL en Supabase) ‚Äî Base de datos vectorial integrada en la misma instancia de Supabase que ya usamos para auth y datos relacionales. Soporta √≠ndices HNSW/IVFFlat, cosine similarity, y queries SQL normales combinadas con b√∫squeda vectorial.
- **Opci√≥n B**: Pinecone ‚Äî Base de datos vectorial SaaS dedicada. Excelente rendimiento a escala, fully managed, pero servicio externo adicional con coste separado (~$70/mes plan Starter).
- **Opci√≥n C**: Weaviate ‚Äî Open source, self-hosted o cloud. Potente pero requiere infraestructura adicional y expertise en operaciones.
- **Opci√≥n D**: Chroma ‚Äî Ligero, open source, ideal para prototipos. No recomendado para producci√≥n client-facing.

## 3. Decisi√≥n Elegida: pgvector en Supabase

**Justificaci√≥n T√©cnica**:

1. **Cero infraestructura adicional**: pgvector viene incluido en Supabase. No necesitamos gestionar otro servicio, otro billing, ni otra conexi√≥n de red.
2. **Queries h√≠bridas**: Podemos combinar b√∫squeda vectorial con filtros SQL en una sola query: `SELECT * FROM legislacion WHERE oposicion_id = X ORDER BY embedding <=> query_vector LIMIT 10`. Esto es imposible o complejo en Pinecone.
3. **RLS nativo**: Row Level Security de Supabase aplica tambi√©n a queries vectoriales, manteniendo aislamiento de datos por usuario.
4. **Coste incluido**: El plan Pro de Supabase (~$25/mes) incluye pgvector. Pinecone a√±adir√≠a ~$70/mes adicionales.
5. **Rendimiento suficiente**: Para ~15.000 chunks con √≠ndice HNSW, pgvector ofrece latencia <50ms que es m√°s que aceptable para nuestro caso de uso.
6. **Transaccionalidad**: Podemos actualizar embeddings y metadata en la misma transacci√≥n SQL, garantizando consistencia cuando el BOE monitor detecta cambios.

## 4. Consecuencias (Trade-offs)

- **Positivas**: Arquitectura simplificada (1 servicio vs 2), coste reducido (~$25 vs ~$95/mes), queries h√≠bridas SQL+vector, misma gesti√≥n de backups y RLS.
- **Negativas/Riesgos**: Rendimiento inferior a Pinecone para >100k vectores (mitigado: nuestro MVP tiene ~15k, escalable a ~50k con HNSW). Si escalamos a millones de vectores, habr√≠a que migrar (mitigado: la interfaz de b√∫squeda est√° abstra√≠da en `lib/ai/` facilitando el cambio).

## 5. Notas de Implementaci√≥n

- Extensi√≥n `vector` habilitada en Supabase: `CREATE EXTENSION IF NOT EXISTS vector`.
- Columna `embedding vector(1536)` en tabla `legislacion` (dimensi√≥n de text-embedding-3-small).
- √çndice HNSW: `CREATE INDEX ON legislacion USING hnsw (embedding vector_cosine_ops)`.
- Funci√≥n RPC `match_legislacion(query_embedding, match_count, filter_oposicion)` en Supabase para encapsular la b√∫squeda.
- Script de ingesta: `execution/ingest-legislacion.ts` genera embeddings y los almacena.
