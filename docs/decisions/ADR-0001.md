# ADR: Modelo LLM ‚Äî Claude Sonnet como modelo principal

**ID**: ADR-0001
**Fecha**: 2026-02-15
**Estado**: üü° Propuesto
**Autor**: Claude / Aritz

## 1. Contexto y Problema

OPTEK necesita un modelo LLM que genere preguntas tipo test, corrija desarrollos escritos y eval√∫e exposiciones orales bas√°ndose en legislaci√≥n espa√±ola. El modelo debe:

- Seguir instrucciones estructuradas (JSON output, citas con formato espec√≠fico)
- Manejar contexto largo (art√≠culos de ley completos como contexto RAG)
- Ofrecer una buena relaci√≥n calidad/precio para uso client-facing
- Soportar streaming para UX fluida

## 2. Opciones Consideradas

- **Opci√≥n A**: Claude 4 Sonnet ‚Äî Modelo de gama media-alta de Anthropic. Excelente en seguimiento de instrucciones, output JSON fiable, contexto de 200k tokens. ~$3/M input, ~$15/M output.
- **Opci√≥n B**: Claude 4 Opus ‚Äî Modelo premium de Anthropic. Mayor capacidad de razonamiento pero 5-10x m√°s caro. ~$15/M input, ~$75/M output.
- **Opci√≥n C**: GPT-4o (OpenAI) ‚Äî Competitivo en precio y calidad, pero requiere integraci√≥n con proveedor adicional y no mantiene coherencia con el resto del stack Anthropic.
- **Opci√≥n D**: Claude 4 Haiku ‚Äî Modelo econ√≥mico. Muy r√°pido y barato (~$0.25/M input) pero menor calidad en tareas complejas como evaluaci√≥n de desarrollos jur√≠dicos.

## 3. Decisi√≥n Elegida: Claude 4 Sonnet

**Justificaci√≥n T√©cnica**:

1. **Calidad/Precio √≥ptima**: Sonnet ofrece calidad suficiente para generaci√≥n de tests y correcci√≥n de desarrollos a ~1/5 del coste de Opus. Con 50 usuarios beta, la diferencia es ~120‚Ç¨/mes vs ~600‚Ç¨/mes solo en Claude.
2. **JSON output fiable**: Sonnet sigue instrucciones de formato estructurado con alta fidelidad, cr√≠tico para nuestro pipeline de verificaci√≥n determinista que parsea JSON.
3. **Contexto 200k tokens**: Suficiente para incluir art√≠culos completos de ley como contexto RAG sin truncar.
4. **Streaming nativo**: SDK de Anthropic soporta streaming, permitiendo UX responsive.
5. **Coherencia de stack**: Un solo proveedor (Anthropic) simplifica gesti√≥n de API keys, billing, y mantenimiento.
6. **Escalabilidad a Opus**: Si alg√∫n flujo requiere mayor razonamiento (ej: evaluaci√≥n oral en Fase 2B), se puede escalar selectivamente a Opus sin cambiar la integraci√≥n.

## 4. Consecuencias (Trade-offs)

- **Positivas**: Coste mensual contenido (~130‚Ç¨ beta), latencia aceptable (~2-5s por generaci√≥n), calidad demostrada en instrucciones complejas, upgrade path claro a Opus.
- **Negativas/Riesgos**: Vendor lock-in con Anthropic (mitigado: abstracci√≥n en `/lib/ai/claude.ts`). Sonnet puede fallar en razonamiento jur√≠dico muy complejo (mitigado: verificaci√≥n determinista post-generaci√≥n descarta output incorrecto).

## 5. Notas de Implementaci√≥n

- Abstracci√≥n del cliente Claude en `/lib/ai/claude.ts` para facilitar cambio de modelo.
- Prompts versionados en `directives/OPTEK_prompts.md` con campo `model` por prompt.
- Evaluaci√≥n peri√≥dica con Golden Dataset (`tests/evals/`) para detectar regresiones al cambiar modelo/versi√≥n.
- Monitorizar coste real vs estimado en `monitoring/COSTS.md`.
