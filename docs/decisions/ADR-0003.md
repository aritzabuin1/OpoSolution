# ADR: Detecci√≥n de Cambios Legislativos ‚Äî SHA-256 Hash Comparison

**ID**: ADR-0003
**Fecha**: 2026-02-15
**Estado**: üü° Propuesto
**Autor**: Claude / Aritz

## 1. Contexto y Problema

OPTEK debe detectar diariamente si alg√∫n art√≠culo de legislaci√≥n ha sido modificado en el BOE. Esto es cr√≠tico porque las preguntas de test y correcciones se basan en texto legal vigente; si una ley cambia y no lo detectamos, el usuario recibe informaci√≥n incorrecta. Necesitamos un mecanismo fiable, determinista y eficiente para detectar cambios en el texto de ~5.000-15.000 art√≠culos monitorizados.

## 2. Opciones Consideradas

- **Opci√≥n A**: SHA-256 hash del texto normalizado ‚Äî Almacenar un hash criptogr√°fico del texto de cada art√≠culo. Comparar diariamente el hash del texto obtenido del BOE con el hash almacenado. Si difiere, hay cambio.
- **Opci√≥n B**: Comparaci√≥n textual directa (diff) ‚Äî Descargar el texto y comparar car√°cter a car√°cter con el almacenado. Detecta qu√© cambi√≥ exactamente pero es m√°s costoso computacionalmente y en almacenamiento.
- **Opci√≥n C**: Fecha de √∫ltima modificaci√≥n del BOE ‚Äî Confiar en la fecha de publicaci√≥n de cambios del BOE. M√°s simple pero depende de metadatos externos que pueden ser inconsistentes.
- **Opci√≥n D**: Comparaci√≥n de embeddings (cosine similarity) ‚Äî Generar nuevo embedding y comparar con el anterior. Detectar√≠a cambios sem√°nticos pero es impreciso (un cambio de "30 d√≠as" a "15 d√≠as" podr√≠a no alterar el embedding significativamente) y costoso en API de embeddings.

## 3. Decisi√≥n Elegida: SHA-256 Hash Comparison

**Justificaci√≥n T√©cnica**:

1. **Determinismo absoluto**: SHA-256 detecta CUALQUIER cambio, incluso un solo car√°cter. Para legislaci√≥n, donde cambiar "30 d√≠as" por "15 d√≠as" altera completamente el significado jur√≠dico, necesitamos precisi√≥n binaria, no sem√°ntica.
2. **Eficiencia**: Comparar un hash de 64 caracteres es O(1) vs comparar textos completos. Para 15.000 art√≠culos diarios, la diferencia es significativa.
3. **Sin dependencias externas**: SHA-256 est√° en la librer√≠a est√°ndar de Node.js (`crypto.createHash`). No necesita API calls ni servicios adicionales.
4. **Coste cero**: No consume tokens de API ni recursos de pago. Solo CPU local.
5. **Auditabilidad**: El hash anterior y el nuevo se almacenan en `cambios_legislativos`, creando un trail completo de cambios.

**Normalizaci√≥n pre-hash**: Para evitar falsos positivos por cambios de whitespace o encoding, se aplica normalizaci√≥n antes del hash:
- Trim whitespace
- Colapsar m√∫ltiples espacios a uno
- Normalizar Unicode (NFC)
- Lowercase para comparaci√≥n (preservando original)

## 4. Consecuencias (Trade-offs)

- **Positivas**: Detecci√≥n perfecta de cualquier cambio (0 falsos negativos), coste cero, velocidad O(1) por art√≠culo, auditable.
- **Negativas/Riesgos**: No indica QU√â cambi√≥ (mitigado: almacenamos texto anterior y nuevo en `cambios_legislativos` para diff posterior). Falsos positivos posibles si el BOE cambia formato sin cambiar contenido (mitigado: normalizaci√≥n agresiva del texto antes del hash).

## 5. Notas de Implementaci√≥n

- Funci√≥n `normalizeForHash(text: string): string` en `lib/utils/`.
- Funci√≥n `computeHash(text: string): string` usando `crypto.createHash('sha256')`.
- Script `execution/boe-monitor.ts` ejecuta el cron diario comparando hashes.
- Tabla `cambios_legislativos` almacena: `legislacion_id`, `texto_anterior`, `texto_nuevo`, `hash_anterior`, `hash_nuevo`, `fecha_deteccion`, `tipo_cambio`.
- Cuando se detecta cambio: invalidar preguntas afectadas (`needs_regeneration = true`), regenerar embeddings del art√≠culo.
