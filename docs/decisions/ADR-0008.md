# ADR: Pasarela de Pago ‚Äî Stripe vs Redsys

**ID**: ADR-0008
**Fecha**: 2026-02-15
**Estado**: üü¢ Aceptado
**Autor**: Claude / Aritz

## 1. Contexto y Problema

OPTEK necesita procesar pagos de usuarios espa√±oles con un modelo h√≠brido: compra individual de tests por oposici√≥n (~9.99‚Ç¨) y suscripci√≥n mensual premium (~14.99‚Ç¨/mes). La pasarela debe soportar: pagos con tarjeta, gesti√≥n de suscripciones recurrentes, webhooks para fulfillment, SCA (Strong Customer Authentication) para cumplir PSD2 europeo, y facturaci√≥n/recibos. Los usuarios son espa√±oles, pero podr√≠amos expandir a Latinoam√©rica.

## 2. Opciones Consideradas

- **Opci√≥n A**: Stripe ‚Äî Pasarela global. API excelente, Checkout hosted, Billing para suscripciones, webhooks robustos. Comisi√≥n: 1.5% + 0.25‚Ç¨ (tarjeta europea). SDK TypeScript first-class.
- **Opci√≥n B**: Redsys ‚Äî Pasarela espa√±ola dominante (usada por bancos espa√±oles). Integraci√≥n m√°s compleja, documentaci√≥n menos clara, pero comisiones potencialmente menores (~0.5-1% seg√∫n banco). Muy conocida por usuarios espa√±oles.
- **Opci√≥n C**: PayPal ‚Äî Conocido internacionalmente pero comisiones altas (3.49% + 0.49‚Ç¨) y UX de checkout inferior. No ideal para suscripciones.
- **Opci√≥n D**: Lemonsquizzy / Paddle ‚Äî Merchant of Record (MoR): ellos gestionan IVA, facturas, compliance. Mayor comisi√≥n (~5-8%) pero eliminan complejidad fiscal.

## 3. Decisi√≥n Elegida: Stripe

**Justificaci√≥n T√©cnica**:

1. **Developer Experience**: API REST + SDK TypeScript de primera clase. Documentaci√≥n excepcional. Stripe CLI para testing local de webhooks. Implementaci√≥n estimada: 2-3 d√≠as vs 1-2 semanas para Redsys.
2. **Stripe Checkout**: Hosted checkout page con SCA integrado, responsive, multiidioma. Reduce PCI scope al m√≠nimo (SAQ A). No tocamos datos de tarjeta.
3. **Stripe Billing**: Gesti√≥n nativa de suscripciones con proration, upgrade/downgrade, cancelaci√≥n, per√≠odo de gracia. Para Redsys habr√≠a que implementar toda esta l√≥gica manualmente.
4. **Webhooks robustos**: Firma de webhooks con `stripe-signature`, retry autom√°tico, event log en dashboard. Cr√≠tico para fulfillment (desbloquear contenido tras pago).
5. **Stripe Tax**: C√°lculo autom√°tico de IVA espa√±ol (21%) y futuro IVA de otros pa√≠ses. Con Redsys, la gesti√≥n fiscal es manual.
6. **Customer Portal**: Portal hosted donde los usuarios gestionan su suscripci√≥n, m√©todos de pago, y facturas. Sin c√≥digo adicional.
7. **Escalabilidad internacional**: Si expandimos a Latam, Stripe soporta pagos locales (OXXO, PIX, etc.) sin cambiar integraci√≥n.

## 4. Consecuencias (Trade-offs)

- **Positivas**: Implementaci√≥n r√°pida (2-3 d√≠as), suscripciones gestionadas, SCA/PSD2 incluido, customer portal, webhooks fiables, escalabilidad internacional, documentaci√≥n excelente.
- **Negativas/Riesgos**: Comisi√≥n ~1.5% + 0.25‚Ç¨ vs potencialmente ~0.5-1% de Redsys (diferencia: ~0.75‚Ç¨ por transacci√≥n de 10‚Ç¨, ~150‚Ç¨/a√±o con 200 usuarios). Algunos usuarios espa√±oles pueden preferir ver "Redsys" como pasarela (mitigado: Stripe Checkout muestra logos de Visa/Mastercard). Stripe es proveedor externo no-UE (mitigado: DPA disponible, datos en EU, Stripe tiene registro como procesador GDPR).

**An√°lisis de costes**:
- Con 200 usuarios, ~400 transacciones/a√±o: Stripe fees ~210‚Ç¨/a√±o
- Con Redsys (~0.7%): ~115‚Ç¨/a√±o
- Diferencia: ~95‚Ç¨/a√±o ‚Üí No justifica 1-2 semanas extra de desarrollo

## 5. Notas de Implementaci√≥n

- SDK: `stripe` package en Node.js.
- Checkout: `POST /api/stripe/checkout` ‚Üí `stripe.checkout.sessions.create()` ‚Üí redirect a Stripe.
- Webhook: `POST /api/stripe/webhook` ‚Üí verificar `stripe-signature` ‚Üí procesar evento ‚Üí fulfillment.
- Idempotencia: tabla `stripe_events_processed` para deduplicar webhooks (ver PLAN.md schema BD).
- Productos en Stripe Dashboard: "Test Individual" (one-time, 9.99‚Ç¨), "Premium Mensual" (recurring, 14.99‚Ç¨).
- Customer Portal: `stripe.billingPortal.sessions.create()` desde `/api/stripe/portal`.
- Testing: Stripe CLI `stripe listen --forward-to localhost:3000/api/stripe/webhook`.
